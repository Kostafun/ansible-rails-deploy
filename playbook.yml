---
- hosts: backends
  remote_user: root
  vars_files:
    - "config/vars.yml"

  pre_tasks:
    - name: Local - git add, commit, push
      local_action: shell cd .. && git add ./*
      ignore_errors: yes
      tags: ['commit', 'deploy']

    - local_action: shell cd .. && git commit --allow-empty -m '{{ commit|default("none") }}'
      ignore_errors: yes
      tags: ['commit', 'deploy']

    - local_action: shell cd .. && git push origin {{ branch }}
      ignore_errors: yes
      tags: ['commit', 'deploy']





  roles:
    - { role: common, tags: ["setup"] }

    - { role: postgresql, when: not skip_pg, tags: ["postgresql", "setup"] }

    - { role: sbaerlocher.redis, when: not skip_redis, tags: ["redis", "setup"] }

    - { role: rails }